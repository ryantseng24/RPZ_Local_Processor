# RPZ Local Processor - å·²çŸ¥å•é¡Œèˆ‡é™åˆ¶

## ğŸ“‹ å•é¡Œåˆ—è¡¨

### 1. Infoblox RPZ èˆ‡ F5 DataGroup ç­†æ•¸å·®ç•°

**ç™¼ç¾æ—¥æœŸ**: 2025-11-12
**ç‹€æ…‹**: âœ… å·²ç¢ºèªç‚ºé æœŸè¡Œç‚ºï¼Œé Bug
**å½±éŸ¿ç­‰ç´š**: ä½ï¼ˆä¸å½±éŸ¿åŠŸèƒ½ï¼‰

#### å•é¡Œæè¿°

Infoblox RPZ Zone åŒ¯å‡ºçš„è¨˜éŒ„æ•¸é‡èˆ‡ F5 DataGroup æœ€çµ‚ç­†æ•¸å­˜åœ¨å·®ç•°ï¼š

- **Infoblox rpztw zone**: 58,612 ç­†
- **F5 rpztw DataGroup**: 58,610 ç­†
- **å·®ç•°**: 2 ç­†

#### æ ¹æœ¬åŸå› 

é€™æ˜¯ **BIND RPZ èˆ‡ F5 DataGroup æ¶æ§‹å·®ç•°**å°è‡´çš„é æœŸè¡Œç‚ºï¼š

##### 1. BIND RPZ æ”¯æŒå¤š Landing IP (Round-Robin)

Infoblox å…è¨±åŒä¸€å€‹ domain é…ç½®å¤šå€‹ Landing IPï¼š

```dns
walmstore.com.rpztw.    IN A 182.173.0.181
walmstore.com.rpztw.    IN A 34.102.218.71
*.walmstore.com.rpztw.  IN A 182.173.0.181
*.walmstore.com.rpztw.  IN A 34.102.218.71
```

**ç”¨é€”**: DNS Round-Robinï¼Œå¯å¯¦ç¾è² è¼‰å‡è¡¡æˆ–å†—é¤˜ã€‚

##### 2. F5 DataGroup æ˜¯ Key-Value çµæ§‹

F5 External DataGroup æ¯å€‹ key åªèƒ½å°æ‡‰ä¸€å€‹ valueï¼š

```
"walmstore.com" := "34.102.218.71"     // åªä¿ç•™ä¸€å€‹ IP
".walmstore.com" := "34.102.218.71"    // åªä¿ç•™ä¸€å€‹ IP
```

**é™åˆ¶**: é—œè¯é™£åˆ—ç‰¹æ€§ï¼Œç›¸åŒ key å¾Œé¢çš„å€¼æœƒè¦†è“‹å‰é¢çš„å€¼ã€‚

##### 3. AWK è§£æè¡Œç‚º

`scripts/parse_rpz.sh` ä½¿ç”¨ AWK é—œè¯é™£åˆ—ï¼š

```awk
rpz[$1] = $5  # ç›¸åŒ domain æ™‚ï¼Œå¾Œé¢çš„ IP è¦†è“‹å‰é¢çš„
```

**çµæœ**:
- Infoblox: 4 ç­†è¨˜éŒ„ï¼ˆ2 å€‹ domain Ã— 2 å€‹ IPï¼‰
- F5 DataGroup: 2 ç­†è¨˜éŒ„ï¼ˆ2 å€‹ domain Ã— 1 å€‹ IPï¼‰

#### å¯¦éš›æ¡ˆä¾‹

**walmstore.com åœ¨ Infoblox çš„é…ç½®**:

| Domain | Landing IP | ç‹€æ…‹ |
|--------|------------|------|
| `*.walmstore.com` | 182.173.0.181 | âŒ è¢«è¦†è“‹ |
| `*.walmstore.com` | 34.102.218.71 | âœ… ä¿ç•™ |
| `walmstore.com` | 182.173.0.181 | âŒ è¢«è¦†è“‹ |
| `walmstore.com` | 34.102.218.71 | âœ… ä¿ç•™ |

**F5 DataGroup æœ€çµ‚çµæœ**:

```
".walmstore.com" := "34.102.218.71"    // ä¿ç•™æœ€å¾Œä¸€å€‹ IP
"walmstore.com" := "34.102.218.71"     // ä¿ç•™æœ€å¾Œä¸€å€‹ IP
```

#### å½±éŸ¿åˆ†æ

##### âœ… åŠŸèƒ½ä¸å—å½±éŸ¿

1. **é»‘åå–®æ””æˆªåŠŸèƒ½æ­£å¸¸**ï¼š
   - ç”¨æˆ¶è¨ªå• `walmstore.com` æˆ–å…¶å­åŸŸåä»æœƒè¢«æ””æˆª
   - å°å‘ä»»ä¸€ Landing IP çš„æ•ˆæœç›¸åŒ

2. **æ€§èƒ½å„ªå‹¢**ï¼š
   - F5 DataGroup Key-Value æŸ¥è©¢æ¯”å¤šå€¼æŸ¥è©¢æ›´å¿«
   - ç°¡åŒ– iRule é‚è¼¯

3. **å¯¦éš›æ‡‰ç”¨å ´æ™¯**ï¼š
   - å¤šæ•¸ RPZ å ´æ™¯ä¸éœ€è¦ Round-Robin
   - Landing Page é€šå¸¸åªéœ€è¦ä¸€å€‹ IP

##### âš ï¸ æ½›åœ¨è€ƒé‡

1. **è² è¼‰å‡è¡¡å¤±æ•ˆ**ï¼š
   - å¦‚æœåŸæœ¬æœŸæœ›é€éå¤š IP å¯¦ç¾è² è¼‰å‡è¡¡ï¼ŒF5 ç’°å¢ƒç„¡æ³•é”æˆ
   - å»ºè­°åœ¨ Landing Page å‰ç«¯ï¼ˆå¦‚ Load Balancerï¼‰å¯¦ç¾è² è¼‰å‡è¡¡

2. **å†—é¤˜è¨­è¨ˆå¤±æ•ˆ**ï¼š
   - å¦‚æœæŸå€‹ Landing IP æ•…éšœï¼ŒF5 ä¸æœƒè‡ªå‹•åˆ‡æ›åˆ°å‚™ç”¨ IP
   - å»ºè­°åœ¨åŸºç¤è¨­æ–½å±¤é¢å¯¦ç¾é«˜å¯ç”¨æ€§

#### é©—è­‰æ–¹æ³•

##### æª¢æŸ¥ Infoblox ä¸­æœ‰å¤šå€‹ IP çš„ domain

```bash
# å¾ Infoblox CSV åŒ¯å‡ºä¸­åˆ†æ
awk -F',' 'NR>1 {count[$4]++} END {
    for (d in count) {
        if (count[d] > 1) print d, count[d]
    }
}' infoblox_rpz_data.csv
```

##### æª¢æŸ¥ F5 DNS Express åŸå§‹è³‡æ–™

```bash
# æŸ¥çœ‹ dnsxdump ä¸­æ˜¯å¦æœ‰å¤šå€‹ A è¨˜éŒ„
grep "walmstore.com.rpztw" /var/tmp/rpz_datagroups/raw/dnsxdump_*.out
```

##### æ¯”å°æœ€çµ‚ DataGroup

```bash
# æŸ¥çœ‹æœ€çµ‚åªä¿ç•™ä¸€å€‹ IP
grep "walmstore" /var/tmp/rpz_datagroups/final/rpz.txt
```

#### æ•¸æ“šå°æ¯”

| æŒ‡æ¨™ | Infoblox | F5 DataGroup | èªªæ˜ |
|------|----------|--------------|------|
| ç¸½è¨˜éŒ„æ•¸ | 58,612 | 58,610 | åŒ…å«/ä¸åŒ…å«é‡è¤‡ IP |
| å”¯ä¸€ Domain | 58,610 | 58,610 | å¯¦éš›åŸŸåæ•¸é‡ç›¸åŒ âœ… |
| é‡è¤‡ IP è¨˜éŒ„ | 2 | 0 | è¦†è“‹è¡Œç‚º |

**å…¬å¼**: `Infoblox è¨˜éŒ„æ•¸ - é‡è¤‡ IP æ•¸ = F5 DataGroup è¨˜éŒ„æ•¸`
**é©—è­‰**: `58,612 - 2 = 58,610` âœ…

#### è§£æ±ºæ–¹æ¡ˆ

##### æ–¹æ¡ˆ 1: æ¥å—ç¾ç‹€ï¼ˆæ¨è–¦ï¼‰

**é©ç”¨å ´æ™¯**: Landing Page ä¸éœ€è¦è² è¼‰å‡è¡¡æˆ–å†—é¤˜

- âœ… ç„¡éœ€ä¿®æ”¹
- âœ… æ€§èƒ½æœ€ä½³
- âœ… é‚è¼¯æœ€ç°¡å–®

**ç†ç”±**:
- F5 DataGroup çš„ç”¨é€”æ˜¯å¿«é€Ÿé»‘åå–®æŸ¥è©¢ï¼Œä¸æ˜¯è² è¼‰å‡è¡¡
- å…©å€‹ Landing IP æ•ˆæœç›¸åŒ
- åŸºç¤è¨­æ–½å±¤é¢å·²æœ‰é«˜å¯ç”¨æ€§è¨­è¨ˆ

##### æ–¹æ¡ˆ 2: èª¿æ•´ Infoblox é…ç½®

**é©ç”¨å ´æ™¯**: æƒ³è¦æºé ­èˆ‡ç›®æ¨™æ•¸æ“šå®Œå…¨ä¸€è‡´

```dns
# ç§»é™¤é‡è¤‡çš„ IPï¼Œæ¯å€‹ domain åªä¿ç•™ä¸€å€‹ Landing IP
walmstore.com.rpztw.    IN A 34.102.218.71
*.walmstore.com.rpztw.  IN A 34.102.218.71
```

**å„ªé»**: æ•¸æ“šä¸€è‡´æ€§æ›´å¥½
**ç¼ºé»**: å¤±å» DNS Round-Robin èƒ½åŠ›ï¼ˆä½† F5 æœ¬ä¾†å°±ä¸æ”¯æŒï¼‰

##### æ–¹æ¡ˆ 3: ä¿®æ”¹ AWK é‚è¼¯ï¼ˆä¸æ¨è–¦ï¼‰

ä¿ç•™æ‰€æœ‰ IP ä¸¦é€£æ¥æˆå­—ä¸²ï¼š

```awk
# å°‡å¤šå€‹ IP åˆä½µ
if (rpz[$1]) {
    rpz[$1] = rpz[$1] "," $5
} else {
    rpz[$1] = $5
}
```

**å•é¡Œ**:
- âŒ F5 DataGroup value æ ¼å¼éŒ¯èª¤
- âŒ iRule éœ€è¦ä¿®æ”¹ä»¥æ”¯æŒå¤š IP
- âŒ å¢åŠ è¤‡é›œåº¦ä½†ç„¡å¯¦éš›æ•ˆç›Š

##### æ–¹æ¡ˆ 4: åœ¨æ–‡æª”ä¸­è¨»è¨˜ï¼ˆå·²åŸ·è¡Œï¼‰

è¨˜éŒ„æ­¤å·²çŸ¥è¡Œç‚ºï¼Œé¿å…æœªä¾†èª¤åˆ¤ç‚º Bugã€‚

#### æœ€ä½³å¯¦è¸å»ºè­°

##### Infoblox RPZ é…ç½®

1. **å„ªå…ˆä½¿ç”¨å–®ä¸€ Landing IP**ï¼š
   ```dns
   *.example.com.rpztw.  IN A 34.102.218.71
   ```

2. **é¿å…ä¸å¿…è¦çš„ Round-Robin**ï¼š
   - é™¤éæœ‰æ˜ç¢ºéœ€æ±‚ï¼Œå¦å‰‡æ¯å€‹ domain åªé…ç½®ä¸€å€‹ IP
   - åœ¨ Landing Page å‰ç«¯å¯¦ç¾è² è¼‰å‡è¡¡ï¼Œè€Œé DNS å±¤

3. **å®šæœŸå¯©æŸ¥é…ç½®**ï¼š
   ```bash
   # æª¢æŸ¥å“ªäº› domain æœ‰å¤šå€‹ IP
   # è©•ä¼°æ˜¯å¦çœŸçš„éœ€è¦
   ```

##### F5 ç’°å¢ƒè€ƒé‡

1. **Landing Page é«˜å¯ç”¨æ€§**ï¼š
   - åœ¨ F5 GTM/LTM å±¤é¢å¯¦ç¾
   - è€Œéä¾è³´ DNS Round-Robin

2. **ç›£æ§ DataGroup ç­†æ•¸**ï¼š
   - è¨­å®šåŸºæº–å€¼ï¼ˆå¦‚ 58,610ï¼‰
   - ç•°å¸¸è®ŠåŒ–æ™‚å‘Šè­¦

3. **æ–‡æª”åŒ–å·®ç•°**ï¼š
   - åœ˜éšŠæˆå“¡äº†è§£æ­¤è¡Œç‚º
   - é¿å…èª¤åˆ¤ç‚ºåŒæ­¥å•é¡Œ

#### ç›¸é—œé…ç½®

- **è§£æè…³æœ¬**: `scripts/parse_rpz.sh` (line 32-129)
- **AWK é‚è¼¯**: é—œè¯é™£åˆ—è¦†è“‹è¡Œç‚º
- **å½±éŸ¿ç¯„åœ**: æ‰€æœ‰æœ‰å¤šå€‹ Landing IP çš„ RPZ è¨˜éŒ„

#### ç›£æ§å»ºè­°

```bash
# åœ¨ Infoblox åŒ¯å‡ºå¾Œæª¢æŸ¥é‡è¤‡ IP çš„æ•¸é‡
awk -F',' 'NR>1 {count[$4]++} END {
    dup=0
    for (d in count) if (count[d]>1) dup+=(count[d]-1)
    print "é æœŸ F5 ç­†æ•¸:", NR-1-dup
}' infoblox_rpz_data.csv

# å°æ¯” F5 å¯¦éš›ç­†æ•¸
wc -l /var/tmp/rpz_datagroups/final/rpz.txt
```

#### åƒè€ƒæ–‡æª”

- **BIND RPZ è¦ç¯„**: https://www.ietf.org/archive/id/draft-vixie-dnsop-dns-rpz-00.html
- **F5 External DataGroup**: https://support.f5.com/csp/article/K13926
- **æœ¬å°ˆæ¡ˆè§£æé‚è¼¯**: `scripts/parse_rpz.sh`

---

## ğŸ“ æ›´æ–°æ­·å²

| æ—¥æœŸ | ç‰ˆæœ¬ | èªªæ˜ | ä½œè€… |
|------|------|------|------|
| 2025-11-12 | 1.0 | åˆå§‹è¨˜éŒ„ Infoblox/F5 ç­†æ•¸å·®ç•°å•é¡Œ | Claude Code with Ryan |

---

## ğŸ”— ç›¸é—œæ–‡æª”

- **æ¶æ§‹ç°¡åŒ–ç¸½çµ**: `docs/ARCHITECTURE_SIMPLIFICATION.md`
- **éŒ¯èª¤ Log å®šç¾©**: `docs/ERROR_LOG_DEFINITIONS.md`
- **éƒ¨ç½²æŒ‡å—**: `docs/DEPLOYMENT_GUIDE.md`

---

**æ–‡æª”å»ºç«‹**: 2025-11-12 22:00
**æœ€å¾Œæ›´æ–°**: 2025-11-12 22:00
**ç¶­è­·è€…**: DevOps Team
**ç‹€æ…‹**: Active
