# F5 iCall Exit Code å•é¡Œè§£æ±ºç¸½çµ

## ğŸ¯ å•é¡Œæ¦‚è¿°

**ç—‡ç‹€**: F5 iCall scriptd åœ¨ RPZ å¯¦éš›æ›´æ–°åŸ·è¡Œæ™‚ï¼Œé›–ç„¶æ‰€æœ‰è™•ç†æ­¥é©ŸæˆåŠŸå®Œæˆä¸” DataGroup æ­£å¸¸æ›´æ–°ï¼Œä½†ä»å ±å‘Š "child process exited abnormally" éŒ¯èª¤ã€‚

**å½±éŸ¿**: ç”¢ç”Ÿèª¤å°æ€§ error logï¼Œå¯èƒ½è§¸ç™¼ç›£æ§å‘Šè­¦ï¼Œä½†ç³»çµ±åŠŸèƒ½å®Œå…¨æ­£å¸¸ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› 

### ä¸»è¦å•é¡Œï¼šç¼ºå°‘æ˜ç¢ºçš„é€€å‡ºç¢¼è²æ˜

æ‰€æœ‰ Shell æ¨¡çµ„è…³æœ¬çš„ `main()` å‡½æ•¸çµå°¾éƒ½**æ²’æœ‰æ˜ç¢ºçš„ `return 0` æˆ– `exit 0` èªå¥**ï¼Œå°è‡´å‡½æ•¸è¿”å›æœ€å¾Œä¸€å€‹å‘½ä»¤çš„é€€å‡ºç¢¼ã€‚

### è§¸ç™¼é»ï¼šcleanup() å‡½æ•¸ä¸­çš„ log_debug

**å•é¡Œä»£ç¢¼**ï¼š
```bash
cleanup() {
    # ... æ¸…ç†é‚è¼¯ ...
    log_debug "æ¸…ç†å®Œæˆ"
    # âŒ æ²’æœ‰ return 0
}
```

**log_debug å®šç¾©**ï¼š
```bash
log_debug() {
    [[ $LOG_LEVEL -le $LOG_DEBUG ]] && echo -e "..." >&2
}
```

**åŸ·è¡Œæµç¨‹**ï¼š
1. é è¨­ `LOG_LEVEL=1` (INFO)ï¼Œ`LOG_DEBUG=0`
2. æ¢ä»¶æ¸¬è©¦ `[[ 1 -le 0 ]]` è¿”å› FALSE â†’ **é€€å‡ºç¢¼ 1**
3. cleanup() æ²’æœ‰æ˜ç¢º `return 0` â†’ **è¿”å› 1**
4. main() èª¿ç”¨ cleanup() å¾Œæ²’æœ‰ `exit 0` â†’ **è…³æœ¬é€€å‡ºç¢¼ 1**
5. iCall scriptd æ•ç²éé›¶é€€å‡ºç¢¼ â†’ **å ±éŒ¯**

### æ¬¡è¦å•é¡Œ

1. **æœªä½¿ç”¨çš„è®Šé‡å®£å‘Š**: cleanup() ä¸­æœ‰ `local timestamp_compact=$(timestamp_compact)` ä½†å¾æœªä½¿ç”¨
2. **å®¹éŒ¯æ€§ä¸è¶³**: éƒ¨åˆ†å‘½ä»¤æ²’æœ‰ `|| true` ä¿è­·

---

## ğŸ”§ è§£æ±ºæ–¹æ¡ˆ

### æ ¸å¿ƒä¿®æ­£

ç‚º**æ‰€æœ‰æ¨¡çµ„è…³æœ¬**çš„ main() å‡½æ•¸æ·»åŠ æ˜ç¢ºçš„é€€å‡ºç¢¼ï¼š

```bash
# å‡½æ•¸çµå°¾ä½¿ç”¨ return 0
main() {
    # ... è™•ç†é‚è¼¯ ...
    return 0  # âœ… æ˜ç¢ºè¿”å›æˆåŠŸ
}

# ä¸»è…³æœ¬çµå°¾ä½¿ç”¨ exit 0
main() {
    # ... è™•ç†é‚è¼¯ ...
    exit 0  # âœ… æ˜ç¢ºé€€å‡ºæˆåŠŸ
}
```

### ä¿®æ­£æª”æ¡ˆåˆ—è¡¨

| æª”æ¡ˆ | ä¿®æ­£é …ç›® |
|------|---------|
| **scripts/main.sh** | cleanup() æ·»åŠ  `return 0`<br>main() æ·»åŠ  `exit 0`<br>ç§»é™¤æœªä½¿ç”¨çš„ timestamp_compact è®Šé‡<br>å¢å¼· cleanup æ—¥èªŒ<br>rm å‘½ä»¤æ·»åŠ  `\|\| true` |
| **scripts/update_datagroup.sh** | main() æ·»åŠ  `exit 0` |
| **scripts/extract_rpz.sh** | main() æ·»åŠ  `return 0` |
| **scripts/parse_rpz.sh** | main() æ·»åŠ  `return 0` |
| **scripts/generate_datagroup.sh** | main() æ·»åŠ  `return 0` |

### æ”¹é€²çš„ cleanup() å‡½æ•¸

```bash
cleanup() {
    if [[ "$CLEANUP_TEMP" != "true" ]]; then
        log_info "è·³éæ¸…ç†è‡¨æ™‚æª”æ¡ˆ"
        return 0  # âœ… æ˜ç¢ºè¿”å›
    fi

    log_info "æ¸…ç†è‡¨æ™‚æª”æ¡ˆ..."

    # æ¸…ç†è¶…é 7 å¤©çš„èˆŠæª”æ¡ˆ
    find "$OUTPUT_DIR" -type f -mtime +7 -delete 2>/dev/null || true
    log_info "æ¸…ç†èˆŠæª”æ¡ˆå®Œæˆ"  # âœ… ç¢ºèªè¨Šæ¯

    # æ¸…ç†ç•¶å‰åŸ·è¡Œç”¢ç”Ÿçš„ä¸­é–“æª”æ¡ˆ
    if [[ -n "${DNSXDUMP_FILE:-}" && -f "$DNSXDUMP_FILE" ]]; then
        rm -f "$DNSXDUMP_FILE" || true  # âœ… å®¹éŒ¯ä¿è­·
        log_info "æ¸…ç† dnsxdump æª”æ¡ˆå®Œæˆ"
    fi

    log_info "cleanup å‡½æ•¸å®Œæˆ"
    return 0  # âœ… æ˜ç¢ºè¿”å›æˆåŠŸ
}
```

---

## âœ… é©—è­‰çµæœ

### ä¿®æ­£å‰ï¼ˆæœ€å¾ŒéŒ¯èª¤ï¼‰
```
æ™‚é–“: Nov 12 21:30:01
ç‹€æ…‹: err scriptd - child process exited abnormally
é€€å‡ºç¢¼: 1
```

### ä¿®æ­£å¾Œï¼ˆé¦–æ¬¡æˆåŠŸï¼‰
```
æ™‚é–“: Nov 12 21:42:23
ç‹€æ…‹: INFO - RPZ processing completed in 1s
é€€å‡ºç¢¼: 0
éŒ¯èª¤: ç„¡
```

### æŒçºŒé©—è­‰
- âœ… 21:35, 21:40, 21:45 - ç„¡æ›´æ–°å ´æ™¯å…¨éƒ¨ Exit Code: 0
- âœ… 21:42 - æœ‰æ›´æ–°å ´æ™¯ï¼ˆå®Œæ•´ 5 æ­¥é©Ÿï¼‰Exit Code: 0
- âœ… ç³»çµ±æ—¥èªŒç„¡ä»»ä½• scriptd éŒ¯èª¤
- âœ… DataGroup æ›´æ–°æ­£å¸¸ï¼ˆrpztw: 58609 ç­†ï¼Œphishtw: 821 ç­†ï¼‰

---

## ğŸ“š é—œè¯å•é¡Œ

é€™æ˜¯ F5 iCall scriptd **ç¬¬ä¸‰å€‹ç³»åˆ—å•é¡Œ**çš„ä¿®æ­£ï¼š

| åºè™Ÿ | æ™‚é–“ | å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ¡ˆ | æ–‡ä»¶ |
|-----|------|------|------|---------|------|
| 1 | 17:15-17:55 | debug echo è¼¸å‡ºéŒ¯èª¤ | echo + ANSI é¡è‰²ç¢¼ + éé›¶é€€å‡ºç¢¼ | ç§»é™¤ echoã€ç¦ç”¨é¡è‰²ã€é‡å®šå‘è¼¸å‡º | ICALL_LOG_ERROR_FIX.md |
| 2 | 20:15-20:35 | hostname å‘½ä»¤éŒ¯èª¤ | F5 hostname è¿”å› 1 | æ›¿æ›ç‚º uname -n | HOSTNAME_FIX.md |
| 3 | 21:15-21:46 | é€€å‡ºç¢¼ç•°å¸¸ | log_debug å¤±æ•— + ç¼ºå°‘æ˜ç¢º exit 0 | æ‰€æœ‰æ¨¡çµ„æ·»åŠ  return/exit 0 | EXIT_CODE_FIX.md |

### å…±åŒæ¨¡å¼
- éƒ½æ˜¯å­é€²ç¨‹/å‘½ä»¤è¿”å›éé›¶å°è‡´
- éƒ½åªåœ¨ç‰¹å®šæƒ…æ³è§¸ç™¼ï¼ˆæœ‰å¯¦éš›æ›´æ–°æ™‚ï¼‰
- éƒ½ä¸å½±éŸ¿å¯¦éš›åŠŸèƒ½ï¼Œåªç”¢ç”Ÿèª¤å°æ€§éŒ¯èª¤
- éƒ½éœ€è¦ç³»çµ±åŒ–è¿½è¹¤æ‰èƒ½å®šä½

---

## ğŸ“ ç¶“é©—æ•™è¨“

### 1. F5 iCall ç’°å¢ƒçš„åš´æ ¼æ€§
- iCall scriptd æ¯”æ™®é€š shell æ›´åš´æ ¼åœ°ç›£æ§æ‰€æœ‰å­é€²ç¨‹é€€å‡ºç¢¼
- **å¿…é ˆç¢ºä¿æ¯å€‹å‘½ä»¤å’Œå‡½æ•¸éƒ½è¿”å› 0**
- ä¸èƒ½ä¾è³´éš±å¼çš„é€€å‡ºç¢¼å‚³é

### 2. Bash å‡½æ•¸é€€å‡ºç¢¼é™·é˜±
- å‡½æ•¸è¿”å›**æœ€å¾Œä¸€å€‹å‘½ä»¤**çš„é€€å‡ºç¢¼
- æ¢ä»¶æ¸¬è©¦ `[[ ]]` å¤±æ•—è¿”å› 1
- **ç¸½æ˜¯**åœ¨æˆåŠŸçš„å‡½æ•¸/è…³æœ¬çµå°¾å¯«æ˜ç¢ºçš„ `return 0` / `exit 0`

### 3. æ¢ä»¶æ—¥èªŒå‡½æ•¸çš„éš±æ‚£
```bash
# âŒ å±éšªï¼šç•¶ LOG_LEVEL > LOG_DEBUG æ™‚è¿”å› 1
log_debug "message"

# âœ… å®‰å…¨ï¼šæ˜ç¢ºè¿”å›æˆåŠŸ
log_debug "message"
return 0
```

### 4. ç”¨æˆ¶åé¥‹çš„é‡è¦æ€§
> **ç”¨æˆ¶**: "æˆ‘è¨˜å¾— Script æ˜¯æœ‰åˆ†æ¨¡çµ„çš„ï¼Œä½ æ¯ä¸€å€‹éƒ½æª¢æŸ¥éï¼Ÿ"

é€™å€‹åè¦†å¼·èª¿çš„æé†’æœ€çµ‚æŒ‡å¼•æˆ‘å€‘æ‰¾åˆ°äº†å•é¡Œï¼š**å¿…é ˆæª¢æŸ¥æ‰€æœ‰æ¨¡çµ„è…³æœ¬**ï¼Œè€Œä¸åªæ˜¯ä¸»è…³æœ¬ã€‚

### 5. ç³»çµ±åŒ–é™¤éŒ¯æ–¹æ³•
1. âœ… ä½¿ç”¨ wrapper è…³æœ¬æ•ç²å¯¦éš›é€€å‡ºç¢¼
2. âœ… åˆ†ææœ€å¾ŒåŸ·è¡Œçš„å‘½ä»¤
3. âœ… æª¢æŸ¥**æ‰€æœ‰æ¨¡çµ„**çš„å‡½æ•¸çµå°¾
4. âœ… å°‹æ‰¾éš±å¼é€€å‡ºç¢¼ï¼ˆæ¢ä»¶æ¸¬è©¦ã€æ—¥èªŒå‡½æ•¸ï¼‰

---

## ğŸ“Š å½±éŸ¿åˆ†æ

### Before â†’ After

| æŒ‡æ¨™ | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ |
|-----|-------|-------|
| **æ›´æ–°åŸ·è¡Œ** | âŒ ç”¢ç”Ÿ err log | âœ… æ­£å¸¸å®Œæˆ |
| **é€€å‡ºç¢¼** | 1 | 0 |
| **å‘Šè­¦** | âŒ å¯èƒ½è§¸ç™¼ | âœ… ä¸è§¸ç™¼ |
| **åŠŸèƒ½** | âœ… æ­£å¸¸ï¼ˆä½†æœ‰èª¤å°ï¼‰ | âœ… æ­£å¸¸ |
| **æ—¥èªŒ** | âŒ æ··äº‚ï¼ˆæœ‰éŒ¯èª¤ï¼‰ | âœ… ä¹¾æ·¨æ¸…æ™° |
| **é™¤éŒ¯æ€§** | âŒ å›°é›£ | âœ… æœ‰è©³ç´°æ­¥é©Ÿæ—¥èªŒ |

---

## ğŸ† æœ€ä½³å¯¦è¸å»ºè­°

### Shell è…³æœ¬ç·¨å¯«
```bash
#!/bin/bash
set -euo pipefail

function some_function() {
    # ... è™•ç†é‚è¼¯ ...

    # âœ… ç¸½æ˜¯æ˜ç¢ºè¿”å›
    return 0
}

function main() {
    # ... ä¸»é‚è¼¯ ...

    # âœ… ç¸½æ˜¯æ˜ç¢ºé€€å‡º
    exit 0
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
```

### æ¢ä»¶æ—¥èªŒè™•ç†
```bash
# âŒ é¿å…å°‡æ¢ä»¶æ—¥èªŒä½œç‚ºå‡½æ•¸æœ€å¾Œä¸€å€‹å‘½ä»¤
function cleanup() {
    # ... cleanup logic ...
    log_debug "done"
}

# âœ… åœ¨æ¢ä»¶æ—¥èªŒå¾Œæ˜ç¢ºè¿”å›
function cleanup() {
    # ... cleanup logic ...
    log_debug "done"
    return 0
}
```

### éŒ¯èª¤å®¹éŒ¯
```bash
# âœ… å°å¯èƒ½å¤±æ•—ä½†ä¸å½±éŸ¿çµæœçš„å‘½ä»¤æ·»åŠ  || true
find "$DIR" -type f -mtime +7 -delete 2>/dev/null || true
rm -f "$TEMP_FILE" || true
```

---

**å»ºç«‹æ—¥æœŸ**: 2025-11-12
**è§£æ±ºæ—¥æœŸ**: 2025-11-12 21:46
**é©—è­‰ç‹€æ…‹**: âœ… **ç”Ÿç”¢ç’°å¢ƒé©—è­‰é€šé**
**æ–‡ä»¶ä½œè€…**: Claude Code with Ryan
**ç‰ˆæœ¬**: 1.0
